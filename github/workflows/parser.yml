name: CoinMarketCap AI Parser

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    - cron: '0 */6 * * *'
    
    # –ò–ª–∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:
    
    # –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
    # - cron: '0 */3 * * *'
    
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00 UTC
    # - cron: '0 9 * * *'
    
    # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 10:00 UTC
    # - cron: '0 10 * * 1'
  
  # –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:
    inputs:
      debug:
        description: 'Debug mode'
        required: false
        default: 'false'
        type: boolean

env:
  MAX_QUESTIONS: 8
  MAX_RETRIES: 2

jobs:
  run-parser:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3 \
          libnspr4 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libcups2 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libasound2 \
          libx11-xcb1
        
    - name: Cache Playwright browsers
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install Playwright
      run: |
        python -m playwright install chromium
        python -m playwright install-deps
        
    - name: Create credentials file for Google Sheets
      if: secrets.GOOGLE_CREDENTIALS != ''
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
        echo "‚úì Google credentials configured"
        
    - name: Debug info
      if: inputs.debug == 'true'
      run: |
        echo "Python version: $(python --version)"
        echo "Playwright version: $(python -c 'import playwright; print(playwright.__version__)')"
        echo "Current directory: $(pwd)"
        ls -la
        
    - name: Run CoinMarketCap AI Parser
      timeout-minutes: 30
      run: |
        python parser.py
        
    - name: Upload results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cmc-parser-results-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          cmc_full_data.json
          cmc_questions_answers.csv
          screenshot_final.png
        retention-days: 7
        if-no-files-found: warn
        
    - name: Notify success
      if: success()
      run: |
        echo "‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö"
        
    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
